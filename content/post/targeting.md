+++
date = "2019-01-03"
title = "Таргетинг"
slug = "targeting"
categories = [ "Алгоритмы" ]
tags = [ "code", "ads" ]
draft = true
+++

Пользователям нужно показывать подходящую рекламу. Если человек зашел на сайт из России, то баннера должны быть на русском языке и рекламировать товар который можно купить или заказать в России. Еще пример: для людей с айфонами нет смыла рекламировать приложения для андроида. Реклама для мобильных устройств очень сильно отличается от рекламы для настольных компьютеров.

Все это заставляет нас, разработчиков, выдумывать способы подбора правильного баннера.

## Откуда брать данные для тергетирования

Для начала нужно где-то взять данные по которым будем таргетироваться. Данные о операционной системе, устройстве и браузере можно брать из юзер агента браузера.

Чтобы получить данные из строки юзер агента, нужно использовать какой ни будь парсер. Выглядит простой задачей. Но, на самом деле, про это можно написать отдельную статью. Юзер агентов очень много, четко определенного формата нет и приходиться учитывать целую тонну нюансов.

Поэтому у нас небольшой выбор для разбора юзер агента. Есть широко известный в узких кругах проект [ua-parser](https://github.com/ua-parser/) и менее известный поект [yauaa](https://github.com/nielsbasjes/yauaa). Про yauaa и пр парсинг юзер агентов можно почитать в статье "Making sense of the user agent string(https://techlab.bol.com/making-sense-user-agent-string/)"

Я выбрал yauaa. Эту штуку можно запустить в докере как отдельный сервис и не париться с подключением зависимостей.  

## Как подобрать нужный баннер

https://www.youtube.com/watch?v=rUbdi_UmrCw

## Простой перебор

Самое первое сто приходит в голову - перебрать в цикле все баннера и проверить их настройки. Но это порочный путь.

### Алгоритм маляра Шлемиэля

Про этот алгоритм хорошо написал Джоэл Х. Спольски в своей книге "Джоэл о программировании".

Маляр Шлемиэль подрядился красить пунктирные осевые линии надорогах. В первый день он получил банку краски, поставил её на дорогу,и к концу дня покрасил 300 метров осевой линии. "Отлично!" сказал прораб, "быстро работаешь!" - и заплатил ему копейку.

На следующий день Шлемиэль покрасил 150 метров. "Мда, это, конечно,не так здорово, как вчера, но приемлемо." - сказал прораб и заплатилему копейку.

На следующий день Шлемиэль покрасил 30 метров. "Всего лишь 30!"заорал прораб. "Это никуда не годится! В первый день было в десять разбольше! В чём дело?"

"Ничего не могу поделать," - говорит Шлемиэль. "Каждый день я ухожу всё дальше и дальше от банки!"

Как вы поняли, перебор будет хорошо работать когда вам нужно выбрать из 100 баннеров. Но когда их   будет 10 000 или даже 100 000, то все станет очень плохо.

## Как работает битмап индекс

[Битмап индекс](https://en.wikipedia.org/wiki/Bitmap_index)

Для нашего примера будем использовать [roaringbitmap](http://roaringbitmap.org/)

## Ссылки

* [Bitmap index](https://en.wikipedia.org/wiki/Bitmap_index)
* [The mythical bitmap index](https://lemire.me/blog/2008/08/20/the-mythical-bitmap-index/)
* [Как 100 000 раз в секунду выбирать правильный рекламный материал / П.Бейзман (Data-Centric Alliance](https://www.youtube.com/watch?v=rUbdi_UmrCw)
* [A better compressed bitset](http://roaringbitmap.org/)