+++
date = "2018-12-27"
title = "Торги в реальном времени"
slug = "rtb"
categories = [ "Инструменты" ]
tags = [ "RTB", "Exchange", "DSP", "SSP" ]
draft = true
+++

RTB(Real Time Bidding) расшифровывается как торги в реальном времени. По сути, это биржа на которой встречаются три стороны: рекламодатель, площадки и пользователь. Рекламодатель решает сколько он готов заплатить за показ рекламы конкретному пользователю. Торги проходят в реальном времени. За тот период пока грузится страница сайта, пользователь(а точнее информация о нем) выставляется на торги и показ уходит тому рекламодателю который готов больше заплатить за него.

В RTB большую роль играет информация о пользователе. Это история показов рекламы ему, соцдем, геопозиция, данные по ретаргетингу и так далее. Все эти данные привязываются к идентификатору пользователя который, например, сохраняется в куках. Реклама становится более релевантной для пользователя, потому что показ отдается тому рекламодателю, который больше нуждается в этом пользователе. Как идентифицировать пользователей и как собирать данные о таких пользователях - тема отдельных статей.

## Сложные названия

Самое сложное в RTB технологиях - запомнить аббревиатуры названий всех ее частей. 

* **Supply Side Platform (SSP)** – рекламная сеть, площадка или другая система, предоставляющая в аукцион места для показов рекламы (продавец).
* **Demand Side Platfrom (DSP)** — рекламная сеть  предоставляющая в аукцион рекламу — видео, баннеры и пр. (покупатель).
* **Data Management Platform (DMP)** — поставщик данных о пользователях
* **Exchanges** — рекламные биржи/сети, которые обеспечивают связь между площадками и рекламодателями и позволяют продавать рекламу тысячам подключенных площадок.
* **Trading Desk** — централизованная платформа закупки рекламы с использованием экосистемы RTB, позволяющая настраивать параметры выкупа рекламы управлять им в автоматическом режиме. Trading Desk, как правило, является надстройкой над DSP, через которую получает доступ к рекламным местам, доступным в экосистеме RTB. 
* **Publisher** - владелец сайта/площадки.
* **Advertiser** - рекламодатель.

## Как работает RTB

RTB можно представить как взаимодействие между биржей и несколькими покупателями. Покупателей можно назвать акционерами участвующими в торгах. RTB определяет методы продажи микро-товаров(например, показов) через рассылку заявок от биржи к партнерам, сбор ответов от партнеров и определения победителя. Биржа может уведомлять покупателей, что их заявки были приняты. Когда происходит продажа, биржа уведомляет выигравшего покупателя и указывает в уведомлении "клиринговую" цену (эта цена может быть с учетом надбавки биржи). Остальные участники могут быть уведомлены что они проиграли аукцион.

Со временем технологии стали сложнее. Большую популярность приобретает header bidding - технология когда сама биржа работает прямо в браузере на сторону площадки и пропадает необходимость в серверах для SSP части. Теперь появились цепочки покупателей - одна биржа использует другую биржу как поставщика и так далее. Появилось много посредников и агрегаторов.

На схеме ниже как раз изображено несколько бирж и DSP. Биржа может сама выступить в роли потребителя и купить показ у вышестоящего источника(слева) или передать запрос нижестоящим источникам(справа). При таком подходе в биржи реализуют одновременно и SSP и DSP части. Важный момент: на рисунке изображен общий случай с N бирж, но в реальности цепочка не может быть бесконечной из-за различных естественных ограничений(таймауты, наценка бирж и т.д.).

![](/images/rtb/rtb.png)

Запросы ставок(bid request), ответы ставок(bid response) и другие события могут быть реализованы между любыми частями этой системы. Хотя площадки(publisher) и первая биржа в цепочке(Exchange 1), как правило, интегрируются менее стандартизировано. Потребители и поставщики могут не знать о том какая конкретно цепочка будет в итоге. OpenRTB регламентирует как будет происходить коммуникация между субъектом и его соседом справа(demand side, потребителем) и соседом слева(supply side, поставщиком)

Можно проиллюстрировать как буду распространятся события от первого лица. Предположим, что мы одна из бирж в этой цепочке. В таком случае:

* Я предполагаю, что все события ожидания, покупки или потери подтверждаются моим партнером поставщиком(supply side). Это непосредственно интегрированные партнеры слева от меня.

* Я несу ответственность за отправку событий ожидания, покупки и потери только моим партнерам потребителям(demand side). Это непосредственно интегрированные партнеры справа от меня.

* Я брокер и заключаю сделки между моими партнерами поставщиками и потребителями(т.е. партнерами слева и справа от меня) и никакой другой участник, в соответствии с RTB, не может распространять мои сделки вверх или вниз по цепочке.

## Протокол OpenRTB

Реклама в интернете похожа на дикий запад где закон только один - право сильного(или большого). Тем не менее, есть попытки хоть как-то стандартизировать эту область. И яркий пример - протокол OpenRTB. На текущий момент уже есть версия OpenRTB v3.0

В протоколе OpenRTB используется многоуровневый подход. Это делает проще использование различных объектов в разных спецификациях и позволяет разным частям спецификации развиваться самостоятельно. Эта модель изображена на картинке ниже. Конечно, все это распределение по уровням достаточно формальное. Уровень 1 определяет как происходит обмен байтами, уровень 2 определяет какое кодирование (или какой "язык") используется для обмена байтами, уровень 3 описывает как эти байты используются в транзакциях, уровень 4 описывает кто участвует в этих транзакциях

![](/images/rtb/rtb2.png)

Учитывая эту многоуровневую концепцию, IAB Tech Lab определила общую организацию связанных спецификаций как OpenMedia. На картинке ниже пример организации уровней протокола.

![](/images/rtb/rtb3.png)

О всех этих уровнях можно почитать в [спецификации OpenRTB](https://www.iab.com/guidelines/real-time-bidding-rtb-project/). Отдельно можно почитать спецификацию [OpenMedia](https://iabtechlab.com/standards/openmedia/). Спецификация [OpenRTB есть на github](https://github.com/InteractiveAdvertisingBureau/openrtb).

Запрос и ответ в OpenRTB выглядит пугающе, но это только на первый взгляд. Пример запроса ставки с одним элементом на продажу и одной сделкой приватного аукциона. Некоторые необязательные параметры были пропущены. Обратите внимание, что структура полей `spec` и `context` зависит от спецификации в [Advertising Common Object Model (OpenMedia)](https://github.com/InteractiveAdvertisingBureau/AdCOM).

```
{
   "openrtb": {
      "ver": "3.0",
      "domainspec": "adcom",
      "domainver": "1.0",
      "request": {
         "id": "0123456789ABCDEF",
         "tmax": 150,
         "at": 2,
         "cur": [ "USD", "EUR" ],
         "source": {
            "tid": "FEDCBA9876543210",
            "ts": 1541796182157,
            "ds": "AE23865DF890100BECCD76579DD4769DBBA9812CEE8ED90BF",
            "dsmap": "...",
            "cert": "ads-cert.1.txt",
            "pchain": "..."
         },
         "package": 0,
         "item": [
            {
               "id": "1",
               "qty": 1,
               "private": 0,
               "deal": [
                  {
                     "id": "1234",
                     "flr": 1.50
                  }
               ],
               "spec": {
                  "placement": {  Refer to the AdCOM Specification.  }
               }
            }
         ],
         "context": {
            "site": {  Refer to the AdCOM Specification.  },
            "user": {  Refer to the AdCOM Specification.  },
            "device": {  Refer to the AdCOM Specification.  },
            "regs": {  Refer to the AdCOM Specification.  },
            "restrictions": {  Refer to the AdCOM Specification.  }
         }
      }
   }
}
```

Если предположить что на запрос выше мы получили ответ, то в этом ответе `response.id` должен совпадать с `request.id`. Поле `bid.item` зависит от поля `item.id` в запросе и `bid.deal` совпадает с `deal.id`. Объект `media` зависит от спецификации в [AdCOM](https://github.com/InteractiveAdvertisingBureau/AdCOM). В `meia` должно быть хотя бы одно поле    `ad` которое описывает рекламу в случае если ставка выиграет.

```
{
   "openrtb": {
      "ver": "3.0",
      "domainspec": "adcom",
      "domainver": "1.0",
      "response": {
         "id": "0123456789ABCDEF",
         "bidid": "0011223344AABBCC",
         "seatbid": [
            {
               "seat": "XYZ",
               "bid": [
                  {
                     "id": "yaddayadda",
                     "item": "1",
                     "deal": "1234",
                     "price": 1.50,
                     "tactic": "...",
                     "purl": "...",
                     "burl": "...",
                     "lurl": "...",
                     "mid": "...",
                     "macro": [
                        {
                           "key": "TIMESTAMP",
                           "value": "1127987134"
                        },
                        {
                           "key": "CLICKTOKEN",
                           "value": "A7D800F2716DB"
                        }
                     ],
                     "media": {
                        "ad": {  Refer to the AdCOM Specification.  }
                     }
                  }
               ]
            }
         ]
      }
   }
}
```

## Как этим всем пользоваться

RTB технологию придумали уже достаточно давно. Но вменяемых открытых проектов все еще мало. Один из самых известных проектов - [rtbkit](https://github.com/rtbkit/rtbkit). К сожалению этот проект мертв и не развивается.

Еще один проект [vanilla-rtb](https://github.com/venediktov/vanilla-rtb). Наверное, это лучшее что есть на данные момент. Конечно, придется немного повозиться с настройкой и запуском всего этого добра.

Для любителей ентерпрайза, есть реализация [OpenRTB протокола на Java](https://github.com/google/openrtb).

Рано или поздно вам захочется написать свою RTB с танцовщицами и шахматами. Как мне кажется, лучше всего для этого подходит язык Go. Для этого языка есть готовая [реализация протокола OpenRTB](https://github.com/bsm/openrtb). И есть готовые примеры, [например DSP API](https://github.com/satoshi03/go-dsp-api)

В 2015 году Даниил Подольский на HighLoad++ рассказывал как писать RTB DSP на языке Go:

<iframe width="900" height="500" src="https://www.youtube.com/embed/C1jm55vFejw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

Можно не писать совсем все на Go. Vanilla-rtb предоставляет биндинги для Node.js, Golang, Python, PHP и Java. Теоретически, можно писать бидеры на Go с использованием фреймворка vanilla. Есть даже видео как все это можно реализовать.

<iframe width="900" height="500" src="https://www.youtube.com/embed/saJQ-Y_VkCA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

## Математика

Реализация всех систем, которые участвуют в RTB - это вызов для разработчиков. Нужно очень быстро обрабатывать много запросов. Учитывать таргетинги, ограничения по показам, ретаргетинг и много чего еще.

Кроме этого, торги в реальном времени это сложная задача для исследователей. Как выгодно делать ставки? Как повысить заинтересованность пользователей, CTR и т.д.? Все это интересные задачи, которые требуют серьезных исследований.
Jun Wang, Weinan Zhang и Shuai Yuan написали целую книгу "[Display Advertising with Real-Time Bidding (RTB) and Behavioural Targeting](https://arxiv.org/abs/1610.03013)". 

Эти же ребята написали целую пачку работ по RTB:

* [Learning, Prediction and Optimisation in RTB Display Advertising](/docs/rtb/cikm-16-rtb-full.pdf) by Weinan Zhang and Jian Xu. CIKM 2016
* [Real-Time Bidding based Display Advertising: Mechanisms and Algorithms](/docs/rtb/ecir16-rtb.pdf) by Jun Wang, Shuai Yuan and Weinan Zhang. ECIR 2016.
* [Real-Time Bidding: A New Frontier of Computational Advertising Research](/docs/rtb/Real-Time Bidding A New Frontier of Computational Advertising Research.pdf) by Shuai Yuan and Jun Wang. WSDM 2015.
* [Research Frontier of Real-Time Bidding based Display Advertising](/docs/rtb/rtb-frontier-2015.pdf) by Weinan Zhang. Beijing 2015.

[Список пейперов и докладов](https://github.com/wnzhang/rtb-papers) для тех у кого есть желание с головой погрузиться в теорию торгов в реальном времени.

Если хорошо поискать, то можно найти записи докладов Jun Wang, Weinan Zhang и Shuai Yuan. Например, тут Jun Wang рассказывает про механизмы и алгоритмы RTB

<iframe width="900" height="500" src="https://www.youtube.com/embed/PtcAE1BT2HE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

## Польза RTB

Переход на покупку конкретных показов. Теперь не нужно покупать тысячи показов и пытаться выковырять бриллианты из грязи. Если качество трафика на площадке падает или меняется его состав — рекламодатель этого даже не заметит. Он покупает показы только интересующим его пользователям. Всякий левый трафик больше не попадает ему в нагрузку. Практически рекламодатели покупают свою целевую аудиторию, а не место на сайте.

Система "второй цены", которая оптимизирует расходы на рекламу. Торги ведутся с шагом 1 цент и если вы указали стоимость за показ в 11 центов, а ваш конкурент — в 9, то вы выигрываете аукцион, но ваша ставка автоматически уменьшается до минимально большей, чем у конкурента — в данном случае, 10 центов.

Технология генерации баннера "на лету" позволяет показать каждому пользователю свой, уникальный баннер - исходя из его уникальных интересов и характеристик. Это позволяет существенно увеличить отклик пользователя на баннер, в том числе CTR.

## Ссылки

* [Wiki: Торг в реальном времени](https://bit.ly/1MBSbGQ)
* [Протокол OpenRTB](https://www.iab.com/guidelines/real-time-bidding-rtb-project/)
* [Что такое RTB: новые технологии интернет-рекламы](https://habr.com/post/169267/)
* [Real Time Bidding (RTB) based Display Advertising System Mechanisms and Algorithms - Jun Wang](https://www.youtube.com/watch?v=PtcAE1BT2HE)
* [RU, RTB DSP на языке Go укрощение buzzwords / Даниил Подольский (Qmobi Com)](https://www.youtube.com/watch?v=C1jm55vFejw)
* [Программатик реклама – модный термин или будущее рекламного рынка?](https://texterra.ru/blog/programmatik-reklama-modnyy-termin-ili-budushchee-reklamnogo-rynka.html)
* [Curated list of awesome real-time bidding frameworks](https://github.com/vanilla-rtb/awesome-rtb)
* [Real Time Bidding (RTB) - Demand Side Platform framework extensions](https://www.youtube.com/watch?v=saJQ-Y_VkCA)